{% extends "base.html" %}

{% block title %}Food Recipe Generator - Grow Calculator{% endblock %}

{% block meta_description %}
Generate random food recipes in Roblox Grow A Garden. Discover cooking mechanics, ingredient combinations, and create unique dishes with our recipe generator.
{% endblock %}
{% block meta_keywords %}
food recipes, grow a garden cooking, recipe generator, cooking mechanics, ingredient combinations, food crafting
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="text-center py-12 bg-gradient-to-b from-orange-600 to-orange-800 text-white">
    <div class="max-w-4xl mx-auto px-4">
        <h1 class="text-4xl md:text-6xl font-bold mb-4">Food Recipe Generator</h1>
        <p class="text-xl md:text-2xl text-orange-100">
            Discover cooking mechanics and generate random recipes!
        </p>
    </div>
</section>

<!-- Statistics Summary Section -->
<section class="bg-gray-900 py-8">
    <div class="max-w-6xl mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center">
                <div class="text-4xl font-bold text-orange-400 mb-2" id="total-recipes">-</div>
                <div class="text-gray-300">Total Recipes</div>
            </div>
            <div class="text-center">
                <div class="text-4xl font-bold text-blue-400 mb-2" id="total-combinations">-</div>
                <div class="text-gray-300">Total Combinations</div>
            </div>
            <div class="text-center">
                <div class="text-4xl font-bold text-green-400 mb-2" id="avg-combinations">-</div>
                <div class="text-gray-300">Avg per Recipe</div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<main class="w-full max-w-6xl mx-auto px-4 py-8">

    <!-- Recipe Generator Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <h2 class="text-2xl font-bold mb-6 text-orange-400">üé≤ Random Recipe Generator</h2>

        <div class="bg-gray-700 p-6 rounded-lg">
            <div class="flex flex-col lg:flex-row gap-4 items-center mb-4">
                <select id="recipe-selector" class="flex-1 p-3 rounded-lg bg-gray-600 text-white border border-gray-500 focus:border-orange-400 focus:outline-none">
                    <option value="">Select a recipe...</option>
                </select>
                <button id="generate-recipe" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition-colors">
                    üé≤ Generate Recipe
                </button>
            </div>

            <!-- Shop Seeds Toggle -->
            <div class="flex items-center justify-center gap-3 p-3 bg-gray-600 rounded-lg">
                <label class="flex items-center gap-2 text-white cursor-pointer">
                    <input type="checkbox" id="shop-seeds-only" class="w-4 h-4 text-orange-600 bg-gray-700 border-gray-500 rounded focus:ring-orange-500 focus:ring-2">
                    <span class="text-sm font-medium">üå± Shop Seeds Only</span>
                </label>
                <span class="text-gray-400 text-xs">(Use only basic seeds available in the shop)</span>
            </div>

            <div id="recipe-result" class="mt-6 min-h-[200px] bg-gray-600 rounded-lg p-4">
                <p class="text-gray-400 text-center">Select a recipe and click generate to see random ingredient combinations!</p>
            </div>
        </div>
    </section>

    <!-- Cooking Mechanics Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <h2 class="text-2xl font-bold mb-6 text-green-400">üìö How Cooking Works</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-green-400 mb-2">‚è±Ô∏è Cooking Time</h3>
                <p class="text-gray-300 text-sm">Each recipe has a base cooking time in seconds. More complex recipes take longer to prepare.</p>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-400 mb-2">‚öñÔ∏è Food Weight</h3>
                <p class="text-gray-300 text-sm">Cooked food has a specific weight that affects storage and transportation in the game.</p>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-purple-400 mb-2">üèÜ Priority System</h3>
                <p class="text-gray-300 text-sm">Recipes have priority levels. Lower numbers mean higher priority and better value.</p>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-yellow-400 mb-2">üß™ Ingredient Categories</h3>
                <p class="text-gray-300 text-sm">Ingredients are grouped by categories like Bread, Meat, Leafy, Sweet, etc.</p>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-red-400 mb-2">üîÑ Random Generation</h3>
                <p class="text-gray-300 text-sm">Each category can use different plants, creating unique recipe variations every time.</p>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-indigo-400 mb-2">üå± Plant Traits</h3>
                <p class="text-gray-300 text-sm">Plants with specific traits can be used in multiple ingredient categories.</p>
            </div>
        </div>
    </section>

    <!-- Recipe Browser Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <h2 class="text-2xl font-bold mb-6 text-yellow-400">üç≥ Recipe Browser</h2>

        <div class="mb-4">
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="difficulty-filter px-3 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition-colors" data-difficulty="">All Recipes</button>
                <button class="difficulty-filter px-3 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition-colors" data-difficulty="Easy">Easy (1-2 ingredients)</button>
                <button class="difficulty-filter px-3 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition-colors" data-difficulty="Medium">Medium (3-4 ingredients)</button>
            </div>

            <input
                type="text"
                id="recipe-search"
                placeholder="Search recipes..."
                class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-yellow-400 focus:outline-none transition-colors"
            >
        </div>

        <div id="recipes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Recipes will be populated by JavaScript -->
        </div>
    </section>

    <!-- Ingredient Categories Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg hidden">
        <h2 class="text-2xl font-bold mb-6 text-blue-400">ü•¨ Ingredient Categories</h2>

        <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Categories will be populated by JavaScript -->
        </div>
    </section>
</main>

<!-- Recipe Details Modal -->
<div id="recipe-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" aria-hidden="true">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="modal-recipe-name">
            <div class="p-4 md:p-6">
                <div class="relative flex items-center justify-center mb-4">
                    <h3 id="modal-recipe-name" class="text-lg md:text-xl font-bold text-orange-400"></h3>
                    <button onclick="closeRecipeModal()" class="absolute right-0 text-gray-400 hover:text-white text-2xl" aria-label="Close modal">&times;</button>
                </div>

                <div id="modal-recipe-content">
                    <!-- Recipe details will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/* ------------------------------ */
/* Recipe Page Specific JavaScript */
/* ------------------------------ */
document.addEventListener('DOMContentLoaded', () => {
    initializeRecipeGenerator();
});

function initializeRecipeGenerator() {
    loadAllRecipesWithStats();
    loadRecipeCategories();
    loadShopSeeds();
    setupEventHandlers();
}

function setupEventHandlers() {
    const recipeSelector = document.getElementById('recipe-selector');
    const generateButton = document.getElementById('generate-recipe');
    const difficultyFilters = document.querySelectorAll('.difficulty-filter');
    const recipeSearch = document.getElementById('recipe-search');

    generateButton.addEventListener('click', generateRandomRecipe);

    difficultyFilters.forEach(button => {
        button.addEventListener('click', function () {
            difficultyFilters.forEach(btn => btn.classList.remove('bg-orange-600'));
            this.classList.add('bg-orange-600');
            loadRecipesByDifficulty(this.dataset.difficulty);
        });
    });

    let searchTimeout;
    recipeSearch.addEventListener('input', function () {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchRecipes(this.value);
        }, 300);
    });
}

async function loadAllRecipesWithStats() {
    try {
        const response = await fetch('/api/recipes/all-with-stats');
        const data = await response.json();

        if (data.success) {
            populateRecipeSelector(data.recipes);
            displayRecipesGrid(Object.fromEntries(data.recipes));
            updateStatistics(data.recipes);
        }
    } catch (error) {
        console.error('Error loading recipes:', error);
    }
}

function populateRecipeSelector(recipes) {
    const selector = document.getElementById('recipe-selector');
    selector.innerHTML = '<option value="">Select a recipe...</option>';

    Object.keys(recipes).forEach(recipeName => {
        const option = document.createElement('option');
        option.value = recipeName;
        option.textContent = recipeName;
        selector.appendChild(option);
    });
}

function displayRecipesGrid(recipes) {
    const grid = document.getElementById('recipes-grid');

    const recipesHtml = Object.entries(recipes).map(([name, recipe]) => {
        const difficulty = getDifficulty(recipe.count);
        const difficultyColor = getDifficultyColor(difficulty);

        return `
            <div class="bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors" onclick="showRecipeDetails('${name}')">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-white">${name}</h4>
                    <span class="bg-${difficultyColor} text-white px-2 py-1 rounded text-sm">${difficulty}</span>
                </div>
                <p class="text-gray-400 text-sm mb-2">${recipe.description}</p>

                <div class="flex justify-between text-xs text-gray-500">
                    <span>‚è±Ô∏è ${recipe.base_time}s</span>
                    <span>‚öñÔ∏è ${recipe.base_weight}kg</span>
                    <span>üèÜ ${recipe.priority}</span>
                </div>
            </div>
        `;
    }).join('');

    grid.innerHTML = recipesHtml;
}

function getDifficulty(count) {
    if (count <= 2) return 'Easy';
    if (count <= 4) return 'Medium';
    return 'Medium';
}

function getDifficultyColor(difficulty) {
    switch (difficulty) {
        case 'Easy':
            return 'green-600';
        case 'Medium':
            return 'yellow-600';
        default:
            return 'gray-600';
    }
}

async function generateRandomRecipe() {
    const recipeName = document.getElementById('recipe-selector').value;
    if (!recipeName) {
        alert('Please select a recipe first!');
        return;
    }

    const shopSeedsOnly = document.getElementById('shop-seeds-only').checked;

    try {
        const response = await fetch(`/api/recipes/generate/${encodeURIComponent(recipeName)}?shop_seeds_only=${shopSeedsOnly}`);
        const data = await response.json();

        if (data.success) {
            displayGeneratedRecipe(data.recipe);
        }
    } catch (error) {
        console.error('Error generating recipe:', error);
        document.getElementById('recipe-result').innerHTML = '<p class="text-red-400 text-center">Error generating recipe</p>';
    }
}

function displayGeneratedRecipe(recipe) {
    const resultDiv = document.getElementById('recipe-result');

    const ingredientsHtml = Object.entries(recipe.ingredients).map(([category, items]) => {
        const itemsHtml = items.map(item => {
            const traitsStr = item.traits.length > 0 ? ` (${item.traits.join(', ')})` : '';
            const isShopSeed = window.shopSeeds && window.shopSeeds.includes(item.item);
            const bgColor = isShopSeed ? 'bg-green-600' : 'bg-blue-600';
            const shopSeedIcon = isShopSeed ? 'üå± ' : '';
            return `<span class="inline-block ${bgColor} text-white px-3 py-1 rounded-full text-sm mr-2 mb-2">${shopSeedIcon}${item.item}${traitsStr}</span>`;
        }).join('');

        return `
            <div class="mb-3">
                <h4 class="text-lg font-semibold text-white mb-2">${category}</h4>
                <div>${itemsHtml}</div>
            </div>
        `;
    }).join('');

    const shopSeedsOnly = document.getElementById('shop-seeds-only').checked;
    const shopSeedsBadge = shopSeedsOnly ? '<div class="bg-green-600 text-white px-3 py-1 rounded-full text-sm mb-4 inline-block">üå± Shop Seeds Only</div>' : '';

    // Get the food image filename
    const foodImageName = recipe.recipe_name.toLowerCase().replace(/\s+/g, '_');
    const foodImagePath = `/static/img/food_${foodImageName}.webp`;

    resultDiv.innerHTML = `
        <div class="text-center">
            <h3 class="text-2xl font-bold text-orange-400 mb-4">${recipe.recipe_name}</h3>

            <!-- Food Image -->
            <div class="flex justify-center mb-4">
                <img src="${foodImagePath}" alt="${recipe.recipe_name}"
                     class="w-32 h-32 object-contain rounded-lg border-2 border-orange-400/30"
                     onerror="this.style.display='none'">
            </div>

            ${shopSeedsBadge}
            <div class="mb-4">
                ${ingredientsHtml}
            </div>

            <div class="grid grid-cols-3 gap-4 text-sm mb-4">
                <div class="bg-gray-700 p-2 rounded">
                    <span class="text-orange-400">‚è±Ô∏è Time:</span> ${recipe.recipe_data.base_time}s
                </div>
                <div class="bg-gray-700 p-2 rounded">
                    <span class="text-blue-400">‚öñÔ∏è Weight:</span> ${recipe.recipe_data.base_weight}kg
                </div>
                <div class="bg-gray-700 p-2 rounded">
                    <span class="text-purple-400">üèÜ Priority:</span> ${recipe.recipe_data.priority}
                </div>
            </div>

            <!-- Share Button -->
            <button onclick="shareRecipe('${recipe.recipe_name}', ${JSON.stringify(recipe).replace(/'/g, "\\'")})"
                    class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                üì§ Share Recipe
            </button>
        </div>
    `;
}

// New single helper: posts and copies the share URL
async function shareRecipe(recipeName, recipeData) {
    const payload = {
        recipe_name: recipeName,
        recipe_data: recipeData.recipe_data,
        ingredients: recipeData.ingredients,
        shop_seeds_only: document.getElementById('shop-seeds-only').checked,
        generated_at: new Date().toISOString()
    };

    try {
        const resp = await fetch('/api/recipes/share', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await resp.json();

        if (data.success) {
            const shareUrl = `https://www.fruitcalculator.dohmboy64.com/share/recipe_${data.share_id}`;
            await navigator.clipboard.writeText(shareUrl);
            alert('‚úÖ Recipe shared! Link copied to clipboard.');
        } else {
            alert(`‚ùå Error sharing: ${data.error || 'unknown error'}`);
        }
    } catch (err) {
        console.error('Share API error:', err);
        alert('‚ùå Something went wrong while sharing.');
    }
}

async function loadRecipesByDifficulty(difficulty) {
    try {
        const url = difficulty ? `/api/recipes/difficulty/${difficulty}` : '/api/recipes/all';
        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            const recipes = difficulty ? data.recipes : data.recipes;
            displayRecipesGrid(Object.fromEntries(recipes));
        }
    } catch (error) {
        console.error('Error loading recipes by difficulty:', error);
    }
}

async function searchRecipes(query) {
    if (!query.trim()) {
        loadAllRecipesWithStats();
        return;
    }

    try {
        const response = await fetch(`/api/recipes/search/${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.success) {
            const recipes = Object.fromEntries(data.results);
            displayRecipesGrid(recipes);
        }
    } catch (error) {
        console.error('Error searching recipes:', error);
    }
}

async function loadRecipeCategories() {
    try {
        const response = await fetch('/api/recipes/categories');
        const data = await response.json();

        if (data.success) {
            displayCategoriesGrid(data.categories);
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

async function loadShopSeeds() {
    try {
        const response = await fetch('/api/recipes/shop-seeds');
        const data = await response.json();

        if (data.success) {
            window.shopSeeds = data.shop_seeds;
        }
    } catch (error) {
        console.error('Error loading shop seeds:', error);
        window.shopSeeds = [];
    }
}

function displayCategoriesGrid(categories) {
    const grid = document.getElementById('categories-grid');

    const categoriesHtml = Object.entries(categories).map(([category, items]) => {
        return `
            <div class="bg-gray-700 p-4 rounded-lg">
                <h4 class="font-semibold text-white mb-2">${category}</h4>
                <p class="text-gray-300 text-sm mb-2">${items.length} available items</p>
                <div class="text-xs text-gray-500">
                    ${items.slice(0, 5).join(', ')}${items.length > 5 ? ` +${items.length - 5} more` : ''}
                </div>
            </div>
        `;
    }).join('');

    grid.innerHTML = categoriesHtml;
}

function showRecipeDetails(recipeName) {
    fetch(`/api/recipes/${encodeURIComponent(recipeName)}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const recipe = data.recipe;
                document.getElementById('modal-recipe-name').textContent = recipeName;

                const ingredientsHtml = Object.entries(recipe.ingredients).map(([category, count]) => {
                    return `<span class="inline-block bg-blue-600 text-white px-3 py-1 rounded-full text-sm mr-2 mb-2">${category}: ${count}</span>`;
                }).join('');

                // Combinations data
                fetch('/api/recipes/all-with-stats')
                    .then(res => res.json())
                    .then(comData => {
                        const entry = comData.recipes[recipeName];
                        const combinations = entry ? entry.possible_combinations : 0;
                        const combinationsFormatted = entry ? entry.combinations_formatted : combinations.toString();

                        // Food image in modal
                        const modalFoodImageName = recipeName.toLowerCase().replace(/\s+/g, '_');
                        const modalFoodImagePath = `/static/img/food_${modalFoodImageName}.webp`;

                        document.getElementById('modal-recipe-content').innerHTML = `
                            <div class="text-center">
                                <div class="flex justify-center mb-4">
                                    <img src="${modalFoodImagePath}" alt="${recipeName}"
                                         class="w-40 h-40 object-contain rounded-lg border-2 border-orange-400/30"
                                         onerror="this.style.display='none'">
                                </div>

                                <p class="text-gray-300 mb-4">${recipe.description}</p>

                                <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-3 rounded-lg mb-4 text-center">
                                    <div class="text-white font-bold text-lg">üé≤ ${combinationsFormatted}</div>
                                    <div class="text-purple-200 text-xs">Possible Combinations</div>
                                </div>

                                <div class="mb-4">
                                    <h4 class="text-lg font-semibold text-white mb-2">Required Ingredients:</h4>
                                    ${ingredientsHtml}
                                </div>
                                <div class="grid grid-cols-3 gap-4 text-sm mb-4">
                                    <div class="bg-gray-700 p-2 rounded">
                                        <span class="text-orange-400">‚è±Ô∏è Time:</span> ${recipe.base_time}s
                                    </div>
                                    <div class="bg-gray-700 p-2 rounded">
                                        <span class="text-blue-400">‚öñÔ∏è Weight:</span> ${recipe.base_weight}kg
                                    </div>
                                    <div class="bg-gray-700 p-2 rounded">
                                        <span class="text-purple-400">üèÜ Priority:</span> ${recipe.priority}
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('recipe-modal').classList.remove('hidden');
                    });
            }
        })
        .catch(err => console.error('Error showing recipe details:', err));
}

function closeRecipeModal() {
    document.getElementById('recipe-modal').classList.add('hidden');
}

function updateStatistics(recipes) {
    const totalRecipes = Object.keys(recipes).length;
    const easyCount = Object.values(recipes).filter(r => r.count <= 2).length;
    const mediumCount = Object.values(recipes).filter(r => r.count > 2 && r.count <= 4).length;
    const hardCount = Object.values(recipes).filter(r => r.count > 4).length;

    const totalRecipesDiv = document.getElementById('total-recipes');
    const totalCombinationsDiv = document.getElementById('total-combinations');
    const avgCombinationsDiv = document.getElementById('avg-combinations');

    if (totalRecipesDiv) totalRecipesDiv.textContent = totalRecipes;

    const totalCombinations = Object.values(recipes).reduce((sum, r) => sum + (r.possible_combinations || 0), 0);
    if (totalCombinationsDiv) totalCombinationsDiv.textContent = formatLargeNumber(totalCombinations);

    if (avgCombinationsDiv) {
        const average = totalRecipes > 0 ? totalCombinations / totalRecipes : 0;
        avgCombinationsDiv.textContent = formatLargeNumber(average);
    }
}

function formatLargeNumber(num) {
    if (num < 1000) return num.toString();
    if (num < 1000000) return (num / 1000).toFixed(1) + 'K';
    if (num < 1000000000) return (num / 1000000).toFixed(1) + 'M';
    return (num / 1000000000).toFixed(1) + 'B';
}
</script>
{% endblock %}
